USE master;
IF EXISTS (SELECT name FROM sys.databases WHERE name = 'QLDX')
BEGIN
    ALTER DATABASE QLDX SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE QLDX;
END;
--lệnh tạo data base
CREATE DATABASE QLDX
GO
--lệnh sử dụng databse, mọi câu lệnh phía dưới sử dụng cho DB này
USE QLDX
GO
CREATE TABLE VAITRO(
    ID_VAITRO CHAR(10) PRIMARY KEY,
    TENVAITRO NVARCHAR(100),

)
CREATE TABLE TAIKHOAN (
    USERNAME VARCHAR(50),
    PASS_WORD VARCHAR(100) NOT NULL,
    ID_VAITRO CHAR(10) NOT NULL,
    REF_ID CHAR(10),
    PRIMARY KEY (USERNAME, ID_VAITRO),
    CONSTRAINT FK_VAITRO FOREIGN KEY (ID_VAITRO)
        REFERENCES VAITRO(ID_VAITRO)
);



CREATE TABLE KHACHHANG (
    ID_KH CHAR(10) PRIMARY KEY,
    TENKH NVARCHAR(100),
    SDT VARCHAR(15),
    DIACHI NVARCHAR(200),
);
CREATE TABLE LOAIXE (
    ID_LOAIXE CHAR(10) PRIMARY KEY,
    TENLOAIXE NVARCHAR(100),
    GIA1KM DECIMAL(10, 2)
);
CREATE TABLE TAIXE (
    ID_TX CHAR(10) PRIMARY KEY,
    ID_LOAIXE CHAR(10),
    TENTX NVARCHAR(100),
    NGSINH DATE,
    CCCD VARCHAR(20),
    GPLX VARCHAR(20),
    SDT VARCHAR(15),
    EMAIL VARCHAR(100),
    BIENSOXE VARCHAR(20),
    TENXE NVARCHAR(100),
    CONSTRAINT FK_TAIXE_LOAIXE FOREIGN KEY (ID_LOAIXE)
        REFERENCES LOAIXE(ID_LOAIXE)
        ON UPDATE CASCADE ON DELETE SET NULL
);
CREATE TABLE PHUONGTHUCTHANHTOAN (
    ID_THANHTOAN CHAR(10) PRIMARY KEY,
    LOAIHINHTHANHTOAN NVARCHAR(100),
    TRANGTHAITT BIT
);
CREATE TABLE KHUYENMAI (
    ID_KHUYENMAI CHAR(10) PRIMARY KEY,
    TENKM NVARCHAR(100),
    HANMUC DECIMAL(10,2),
    TGBATDAU DATETIME,
    TGKETTHUC DATETIME,
    DIEUKIENAPDUNG NVARCHAR(200),
    SOLUONG INT
);
CREATE TABLE GIO (
    ID_GIO CHAR(10) PRIMARY KEY,
    THOIGIANBATDAU TIME,
    THOIGIANKETTHUC TIME
);
CREATE TABLE LOAIXE_GIO (
    ID_LOAIXE CHAR(10),
    ID_GIO CHAR(10),
    PHUTHU FLOAT,
    PRIMARY KEY (ID_LOAIXE, ID_GIO),
    CONSTRAINT FK_LOAIXE_GIO_LOAIXE FOREIGN KEY (ID_LOAIXE)
        REFERENCES LOAIXE(ID_LOAIXE)
        ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_LOAIXE_GIO_GIO FOREIGN KEY (ID_GIO)
        REFERENCES GIO(ID_GIO)
        ON UPDATE CASCADE ON DELETE CASCADE
);
CREATE TABLE DATXE (
    ID_DATXE CHAR(10) PRIMARY KEY,
    ID_KH CHAR(10),
    ID_TX CHAR(10),
    ID_THANHTOAN CHAR(10),
    ID_KHUYENMAI CHAR(10),
    DIEMDON NVARCHAR(200),
    DIEMTRA NVARCHAR(200),
    THOIGIANDAT DATETIME,
    THOIGIANDON DATETIME,
    THOIGIANDEN DATETIME,
    TRANGTHAI NVARCHAR(50),
    KHOANGCACH FLOAT,
    DIEMSO INT,
    DANHGIA NVARCHAR(500),
    CONSTRAINT FK_DATXE_KH FOREIGN KEY (ID_KH)
        REFERENCES KHACHHANG(ID_KH)
        ON UPDATE CASCADE ON DELETE SET NULL,
    CONSTRAINT FK_DATXE_TX FOREIGN KEY (ID_TX)
        REFERENCES TAIXE(ID_TX)
        ON UPDATE CASCADE ON DELETE SET NULL,
    CONSTRAINT FK_DATXE_THANHTOAN FOREIGN KEY (ID_THANHTOAN)
        REFERENCES PHUONGTHUCTHANHTOAN(ID_THANHTOAN)
        ON UPDATE CASCADE ON DELETE SET NULL,
    CONSTRAINT FK_DATXE_KHUYENMAI FOREIGN KEY (ID_KHUYENMAI)
        REFERENCES KHUYENMAI(ID_KHUYENMAI)
        ON UPDATE CASCADE ON DELETE SET NULL
);
-- KHUYENMAI: HANMUC ≥ 0
ALTER TABLE KHUYENMAI
ADD CONSTRAINT CHK_KHUYENMAI_HANMUC CHECK (HANMUC >= 0);

-- KHUYENMAI: SOLUONG ≥ 0
ALTER TABLE KHUYENMAI
ADD CONSTRAINT CHK_KHUYENMAI_SOLUONG CHECK (SOLUONG >= 0);

-- DATXE: DIEMSO từ 1 đến 5 (nếu không đánh giá thì NULL)
ALTER TABLE DATXE
ADD CONSTRAINT CHK_DATXE_DIEMSO CHECK (DIEMSO BETWEEN 1 AND 5 OR DIEMSO IS NULL);

-- DATXE: TRANGTHAI chỉ nhận các giá trị hợp lệ (ví dụ: 'Chờ', 'Đã xong', 'Hủy')
ALTER TABLE DATXE
ADD CONSTRAINT CHK_DATXE_TRANGTHAI CHECK (TRANGTHAI IN (N'Đang chờ', N'Hoàn thành', N'Hủy'));

-- PHUONGTHUCTHANHTOAN: TRANGTHAITT là 0 hoặc 1
ALTER TABLE PHUONGTHUCTHANHTOAN
ADD CONSTRAINT CHK_THANHTOAN_TRANGTHAITT CHECK (TRANGTHAITT IN (0, 1));


-- KHACHHANG: SĐT là duy nhất
ALTER TABLE KHACHHANG
ADD CONSTRAINT UQ_KHACHHANG_SDT UNIQUE (SDT);

-- TAIXE: BIENSOXE là duy nhất
ALTER TABLE TAIXE
ADD CONSTRAINT UQ_TAIXE_BIENSOXE UNIQUE (BIENSOXE);

-- TAIXE: EMAIL là duy nhất
ALTER TABLE TAIXE
ADD CONSTRAINT UQ_TAIXE_EMAIL UNIQUE (EMAIL);

-- TAIXE: CCCD là duy nhất
ALTER TABLE TAIXE
ADD CONSTRAINT UQ_TAIXE_CCCD UNIQUE (CCCD);


-- PHUONGTHUCTHANHTOAN: mặc định TRANGTHAITT = 1 (đang hoạt động)
ALTER TABLE PHUONGTHUCTHANHTOAN
ADD CONSTRAINT DF_THANHTOAN_TRANGTHAITT DEFAULT 1 FOR TRANGTHAITT;

-- DATXE: mặc định TRANGTHAI = 'Chờ'
ALTER TABLE DATXE
ADD CONSTRAINT DF_DATXE_TRANGTHAI DEFAULT N'Đang chờ' FOR TRANGTHAI;

-- DATXE: mặc định DIEMSO = NULL (chưa đánh giá)
ALTER TABLE DATXE
ADD CONSTRAINT DF_DATXE_DIEMSO DEFAULT NULL FOR DIEMSO;

-- DATXE: DANHGIA mặc định là NULL
ALTER TABLE DATXE
ADD CONSTRAINT DF_DATXE_DANHGIA DEFAULT NULL FOR DANHGIA;

-- KHACHHANG: SDT phải là chuỗi số và có độ dài 10 hoặc 11
ALTER TABLE KHACHHANG
ADD CONSTRAINT CHK_KHACHHANG_SDT CHECK (
    SDT LIKE '[0-9]%' AND LEN(SDT) IN (10, 11)
);

-- TAIXE: SDT phải là chuỗi số và có độ dài 10 hoặc 11
ALTER TABLE TAIXE
ADD CONSTRAINT CHK_TAIXE_SDT CHECK (
    SDT LIKE '[0-9]%' AND LEN(SDT) IN (10, 11)
);

INSERT INTO LOAIXE (ID_LOAIXE, TENLOAIXE, GIA1KM) VALUES
('LX01', N'Xe máy', 5000),
('LX02', N'Xe ô tô 4 chỗ', 10000),
('LX03', N'Xe ô tô 7 chỗ', 12000),
('LX04', N'Xe ga', 7000);

INSERT INTO KHACHHANG (ID_KH, TENKH, SDT, DIACHI) VALUES
('KH01', N'Lương Bin', '0901234567', N'Hà Nội'),
('KH02', N'Duy Phương', '0912345678', N'Hồ Chí Minh'),
('KH03', N'Vy Hậu', '0987654321', N'Đà Nẵng'),
('KH04', N'Lê Tỉnh', '0934567890', N'Cần Thơ');

INSERT INTO TAIXE (ID_TX, ID_LOAIXE, TENTX, NGSINH, CCCD, GPLX, SDT, EMAIL, BIENSOXE, TENXE) VALUES
('TX01', 'LX01', N'Nguyễn Bin', '1990-05-10', '123456789012', '92B2-12345', '0911000001', 'tx1@example.com', '29A-12345', N'Yamaha Sirius'),
('TX02', 'LX02', N'Thành Long', '1988-03-20', '234567890123', '92B1-23456', '0911000002', 'tx2@example.com', '30B-23456', N'Toyota Vios'),
('TX03', 'LX03', N'Thị Hậu', '1992-09-15', '345678901234', '43B2-34567', '0911000003', 'tx3@example.com', '31C-34567', N'Kia Rondo'),
('TX04', 'LX04', N'Thị Tỉnh', '1985-12-01', '456789012345', '43C1-45678', '0911000004', 'tx4@example.com', '32D-45678', N'SH');


INSERT INTO PHUONGTHUCTHANHTOAN (ID_THANHTOAN, LOAIHINHTHANHTOAN, TRANGTHAITT) VALUES
('TT01', N'Tiền mặt', 1),
('TT02', N'Chuyển khoản', 1),
('TT03', N'Momo', 1),
('TT04', N'ZaloPay', 1);

INSERT INTO KHUYENMAI (ID_KHUYENMAI, TENKM, HANMUC, TGBATDAU, TGKETTHUC, DIEUKIENAPDUNG, SOLUONG) VALUES
('KM01', N'Giảm 20%', 20000, '2025-04-01', '2025-04-30', N'Cho đơn từ 50K', 100),
('KM02', N'Giảm 10K', 10000, '2025-04-01', '2025-04-15', N'Không giới hạn', 50),
('KM03', N'Giảm 30%', 30000, '2025-04-05', '2025-04-20', N'Chỉ áp dụng cuối tuần', 30),
('KM04', N'Miễn phí 5KM đầu', 25000, '2025-04-01', '2025-05-01', N'Tất cả đơn', 80);

INSERT INTO GIO (ID_GIO, THOIGIANBATDAU, THOIGIANKETTHUC) VALUES
('G1', '06:00', '12:00'),
('G2', '12:01', '17:00'),
('G3', '17:01', '22:00'),
('G4', '22:01', '5:59');


INSERT INTO LOAIXE_GIO (ID_LOAIXE, ID_GIO, PHUTHU) VALUES
('LX01', 'G1', 1.25),
('LX02', 'G4', 1.5),
('LX03', 'G3', 1.3),
('LX04', 'G2', 1.4);


INSERT INTO DATXE (ID_DATXE, ID_KH, ID_TX, ID_THANHTOAN, ID_KHUYENMAI, DIEMDON, DIEMTRA, THOIGIANDAT, THOIGIANDON, THOIGIANDEN, TRANGTHAI, KHOANGCACH, DIEMSO, DANHGIA) VALUES
('DX01', 'KH01', 'TX01', 'TT01', 'KM01', N'Hồ Gươm', N'Bến xe Mỹ Đình', '2025-04-07 08:00', '2025-04-07 08:10', '2025-04-07 08:40', N'Đang chờ', 10.5, 5, N'Rất tốt'),
('DX02', 'KH02', 'TX02', 'TT02', 'KM02', N'Quận 1', N'Bình Thạnh', '2025-04-07 09:00', '2025-04-07 09:15', '2025-04-07 09:50', N'Hoàn thành', 8.2, 4, N'Hài lòng'),
('DX03', 'KH03', 'TX03', 'TT03', NULL, N'Sân bay Tân Sơn Nhất', N'Quận 7', '2025-04-07 10:00', '2025-04-07 10:20', '2025-04-07 11:00', N'Đang chờ', 12.6, 5, N'Tốt'),
('DX04', 'KH04', 'TX04', 'TT04', 'KM03', N'Bến xe miền Đông', N'Gò Vấp', '2025-04-07 14:00', '2025-04-07 14:15', '2025-04-07 14:45', N'Hủy', 6.8, NULL, NULL);

INSERT INTO VAITRO(ID_VAITRO,TENVAITRO) VALUES
('USER',N'Khách Hàng'),
('DRIVER',N'Tài Xế'),
('ADMIN',N'Quản trị viên')
INSERT INTO TAIKHOAN (USERNAME, PASS_WORD,ID_VAITRO,REF_ID) VALUES
('LeHoangQuachTinh', '12345', 'USER','KH01'),
('NguyenLuongBin', '12345', 'DRIVER','TX01'),
('NguyenThiVyHau', '12345', 'ADMIN',null)

go
CREATE FUNCTION Fn_TangTuDongID_KhachHang()
RETURNS char(10)
AS 
BEGIN
    DECLARE @next INT;
    DECLARE @ma CHAR(3);
    DECLARE @values CHAR(10);

    SELECT @next = ISNULL(MAX(CAST(RIGHT(ID_KH, 7) AS INT)), 0) + 1
    FROM KHACHHANG;

    SELECT @ma = LEFT(ID_KH, 3)
    FROM KHACHHANG;

    SET @values = @ma + RIGHT('0000000' + CAST(@next AS VARCHAR), 7);

    RETURN @values;
END;
GO

PRINT dbo.Fn_TangTuDongID_KhachHang() 
go
CREATE FUNCTION Fn_TangTuDongID_TaiXe()
RETURNS CHAR(10)
AS 
BEGIN
    DECLARE @next INT;
    DECLARE @ma CHAR(3);
    DECLARE @values CHAR(10);

    SELECT @next = ISNULL(MAX(CAST(RIGHT(ID_TX, 7) AS INT)), 0) + 1
    FROM TAIXE;

    SELECT @ma = LEFT(ID_TX, 3)
    FROM TAIXE;

    SET @values = @ma + RIGHT('0000000' + CAST(@next AS VARCHAR), 7);

    RETURN @values;
END;
GO

PRINT dbo.Fn_TangTuDongID_TaiXe();
